{% extends 'main.html' %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">M-Pesa STK Push Payment</h3>
                </div>
                <div class="card-body">
                    <form id="stkPushForm">
                        <div class="mb-3">
                            <label for="phoneNumber" class="form-label">Phone Number (254...)</label>
                            <input 
                                type="tel" 
                                class="form-control" 
                                id="phoneNumber" 
                                name="phone_number"
                                placeholder="254712345678"
                                required
                            >
                            <small class="form-text text-muted">Format: 254 + phone number without leading 0</small>
                        </div>

                        <div class="mb-3">
                            <label for="amount" class="form-label">Amount (KES)</label>
                            <input 
                                type="number" 
                                class="form-control" 
                                id="amount" 
                                name="amount"
                                placeholder="100"
                                value="1"
                                min="1"
                                required
                            >
                        </div>

                        <button type="submit" class="btn btn-success w-100">
                            <i class="fas fa-mobile-alt"></i> Send STK Push
                        </button>
                    </form>

                    <div id="responseMessage" class="mt-3" style="display:none;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('stkPushForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const phoneNumber = document.getElementById('phoneNumber').value;
    const amount = document.getElementById('amount').value;
    const responseDiv = document.getElementById('responseMessage');
    
    try {
        const response = await fetch('{% url "payments:stk_push" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                phone_number: phoneNumber,
                amount: amount
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            responseDiv.className = 'alert alert-success mt-3';
            responseDiv.innerHTML = `
                <strong>Success!</strong> STK push sent to ${phoneNumber}.<br>
                Please enter your M-Pesa PIN on your phone.
            `;
        } else {
            responseDiv.className = 'alert alert-danger mt-3';
            responseDiv.innerHTML = `<strong>Error!</strong> ${data.message}`;
        }
        responseDiv.style.display = 'block';
    } catch (error) {
        responseDiv.className = 'alert alert-danger mt-3';
        responseDiv.innerHTML = `<strong>Error!</strong> ${error.message}`;
        responseDiv.style.display = 'block';
    }
});
</script>
{% endblock %}
